trigger:
  - master

pool: Default

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "20.x"
    displayName: "Install Node.js"

  - script: |
      echo "Generando aws-exports.js..."
      cat <<EOT > src/aws-exports.js
      /* eslint-disable */
      // WARNING: DO NOT EDIT. This file is automatically generated by AWS Amplify. It will be overwritten.

      const awsmobile = {
          "aws_project_region": "us-east-1",
          "aws_cognito_identity_pool_id": "us-east-1:752b9073-e3f7-4afa-8441-b46a5fa4e355",
          "aws_cognito_region": "us-east-1",
          "aws_user_pools_id": "us-east-1_fGDSsDHa8",
          "aws_user_pools_web_client_id": "2i9jt9gjdragcj9q4aspk31ub4",
          "oauth": {},
          "aws_cognito_username_attributes": ["EMAIL"],
          "aws_cognito_social_providers": [],
          "aws_cognito_signup_attributes": ["EMAIL"],
          "aws_cognito_mfa_configuration": "OFF",
          "aws_cognito_mfa_types": ["SMS"],
          "aws_cognito_password_protection_settings": {
              "passwordPolicyMinLength": 8,
              "passwordPolicyCharacters": []
          },
          "aws_cognito_verification_mechanisms": ["EMAIL"]
      };

      export default awsmobile;
      EOT
    displayName: "Generar aws-exports.js con datos quemados"

  - script: |
      npm install
      npm run build
    displayName: "npm install and build"

  - task: AWSCLI@1
    inputs:
      awsCredentials: "aws-connection"
      regionName: "us-east-1"
      awsCommand: "s3"
      awsSubCommand: "sync"
      awsArguments: "./dist s3://nessum-front-v2 --delete"
    displayName: "Upload to S3"

  - task: AWSCLI@1
    inputs:
      awsCredentials: "aws-connection"
      awsCommand: "cloudfront"
      awsSubCommand: "create-invalidation"
      awsArguments: '--distribution-id E1XYPSZHNKQZDC --paths "/*"'
    displayName: "Invalidate CloudFront"
